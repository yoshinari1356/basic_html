name: PR Preview (GitHub Pages, comment command)

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: read
  issues: write

concurrency:
  group: pr-preview-${{ github.event.issue.number }}
  cancel-in-progress: true

env:
  # å…¬é–‹ã—ãŸã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆrepoç›´ä¸‹ãªã‚‰ "."ã€docs é…ä¸‹ãªã‚‰ "docs" ãªã©ï¼‰
  SITE_DIR: "."

jobs:
  preview:
    # PRã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆã§ã€ã‹ã¤ /preview ãŒå«ã¾ã‚Œã‚‹ã¨ãã ã‘åå¿œ
    if: |
      github.event.issue.pull_request != null &&
      contains(github.event.comment.body, '/preview')

    runs-on: ubuntu-latest

    steps:
      - name: Authorize (allow only write/maintain/admin)
        id: auth
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const login = context.payload.comment.user.login;
            const prNumber = context.payload.issue.number;

            // Collaborator permission level: none/read/triage/write/maintain/admin
            const { data } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner, repo, username: login,
            });

            const perm = data.permission;
            const allowed = ["write", "maintain", "admin"].includes(perm);

            core.setOutput("allowed", String(allowed));
            core.setOutput("perm", perm);
            core.setOutput("login", login);
            core.setOutput("pr_number", String(prNumber));

            if (!allowed) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body:
                  `â›” æ¨©é™ä¸è¶³ã®ãŸã‚å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚\n\n` +
                  `å®Ÿè¡Œè€…: @${login}\n` +
                  `æ¨©é™: ${perm}\n` +
                  `å¿…è¦: write / maintain / admin\n\n` +
                  `ä½¿ã„æ–¹: \`/preview deploy\` ã¾ãŸã¯ \`/preview cleanup\``,
              });
            }

      - name: Parse command
        if: steps.auth.outputs.allowed == 'true'
        id: cmd
        shell: bash
        run: |
          BODY="${{ github.event.comment.body }}"

          # æœŸå¾…ã‚³ãƒãƒ³ãƒ‰:
          #   /preview deploy
          #   /preview cleanup
          if echo "$BODY" | grep -Eq '(^|\s)/preview\s+cleanup(\s|$)'; then
            echo "ACTION=cleanup" >> $GITHUB_OUTPUT
          elif echo "$BODY" | grep -Eq '(^|\s)/preview\s+deploy(\s|$)'; then
            echo "ACTION=deploy" >> $GITHUB_OUTPUT
          else
            echo "ACTION=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Reply usage for unknown command
        if: steps.auth.outputs.allowed == 'true' && steps.cmd.outputs.ACTION == 'unknown'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const prNumber = context.payload.issue.number;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: `âš ï¸ ã‚³ãƒãƒ³ãƒ‰ãŒä¸æ˜ã§ã™ã€‚\n\nä½¿ã„æ–¹:\n- \`/preview deploy\`\n- \`/preview cleanup\``,
            });

      - name: Get PR info (head ref)
        if: steps.auth.outputs.allowed == 'true' && steps.cmd.outputs.ACTION != 'unknown'
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const prNumber = context.payload.issue.number;

            const { data: pr } = await github.rest.pulls.get({
              owner, repo, pull_number: prNumber
            });

            core.setOutput("number", String(pr.number));
            core.setOutput("head_ref", pr.head.ref);
            core.setOutput("head_repo_full_name", pr.head.repo.full_name);

      # deployæ™‚ã ã‘PRãƒ–ãƒ©ãƒ³ãƒã‚’checkout
      - name: Checkout PR branch
        if: steps.auth.outputs.allowed == 'true' && steps.cmd.outputs.ACTION == 'deploy'
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.pr.outputs.head_repo_full_name }}
          ref: ${{ steps.pr.outputs.head_ref }}

      - name: Prepare site files (copy sources; no build)
        if: steps.auth.outputs.allowed == 'true' && steps.cmd.outputs.ACTION == 'deploy'
        shell: bash
        run: |
          mkdir -p .preview_out

          # é™çš„ã‚µã‚¤ãƒˆã‚’ãã®ã¾ã¾ã‚³ãƒ”ãƒ¼ï¼ˆå±é™ºãªã‚‚ã®/å·¨å¤§ãªã‚‚ã®ã¯é™¤å¤–ï¼‰
          rsync -av --delete \
            --exclude ".git/" \
            --exclude ".github/" \
            --exclude "node_modules/" \
            --exclude ".env" \
            --exclude ".env.*" \
            --exclude "*.pem" \
            --exclude "*.key" \
            --exclude "secrets.*" \
            "${SITE_DIR}/" ".preview_out/"

          # SPAã®ãƒªãƒ­ãƒ¼ãƒ‰å¯¾ç­–ï¼ˆä¸è¦ãªã‚‰æ¶ˆã—ã¦OKï¼‰
          if [ ! -f ".preview_out/404.html" ] && [ -f ".preview_out/index.html" ]; then
            cp ".preview_out/index.html" ".preview_out/404.html"
          fi

          # Pagesã®Jekyllå‡¦ç†ã‚’ç„¡åŠ¹åŒ–ã—ãŸã„å ´åˆï¼ˆå¿…è¦ãªã‚‰ï¼‰
          # touch .preview_out/.nojekyll

      - name: Deploy to gh-pages (target folder = pr-<number>)
        if: steps.auth.outputs.allowed == 'true' && steps.cmd.outputs.ACTION == 'deploy'
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: .preview_out
          target-folder: pr-${{ steps.pr.outputs.number }}
          clean: false

      - name: Cleanup preview folder on gh-pages
        if: steps.auth.outputs.allowed == 'true' && steps.cmd.outputs.ACTION == 'cleanup'
        shell: bash
        run: |
          git clone --depth=1 --branch gh-pages \
            "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" ghp

          cd ghp
          PR_DIR="pr-${{ steps.pr.outputs.number }}"

          if [ -d "$PR_DIR" ]; then
            rm -rf "$PR_DIR"
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A

          if git diff --cached --quiet; then
            echo "Nothing to cleanup"
            exit 0
          fi

          git commit -m "chore: remove preview for PR #${{ steps.pr.outputs.number }}"
          git push

      - name: Comment result on PR
        if: steps.auth.outputs.allowed == 'true' && steps.cmd.outputs.ACTION != 'unknown'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const prNumber = Number("${{ steps.pr.outputs.number }}");
            const action = "${{ steps.cmd.outputs.ACTION }}";
            const url = `https://${owner}.github.io/${repo}/pr-${prNumber}/`;

            const body =
              action === "deploy"
                ? `âœ… Preview deployed\n\n${url}\n\nï¼ˆã‚³ãƒãƒ³ãƒ‰: \`/preview deploy\`ï¼‰`
                : `ğŸ§¹ Preview cleaned\n\npr-${prNumber} ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚\n\nï¼ˆã‚³ãƒãƒ³ãƒ‰: \`/preview cleanup\`ï¼‰`;

            await github.rest.issues.createComment({
              owner, repo, issue_number: prNumber, body
            });