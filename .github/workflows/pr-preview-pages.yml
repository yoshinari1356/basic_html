name: PR Preview (GitHub Pages)

on:
  push:
    branches: [master]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize, reopened, closed]

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  # å…¬é–‹ã—ãŸã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆrepoç›´ä¸‹ãªã‚‰ "."ã€docs é…ä¸‹ãªã‚‰ "docs" ãªã©ï¼‰
  SITE_DIR: "."

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # publish_root: master ã®å†…å®¹ã‚’ gh-pages ãƒ«ãƒ¼ãƒˆã¸åŒæœŸï¼ˆpr-* ã¯æ®‹ã™ï¼‰
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  publish_root:
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    concurrency:
      group: pages-root
      cancel-in-progress: true

    steps:
      - name: Checkout master
        uses: actions/checkout@v4

      - name: Prepare root site files
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .site_out
          rsync -av --delete \
            --exclude ".git/" \
            --exclude ".github/" \
            --exclude "node_modules/" \
            --exclude ".env" \
            --exclude ".env.*" \
            --exclude "*.pem" \
            --exclude "*.key" \
            --exclude "secrets.*" \
            "${SITE_DIR}/" ".site_out/"

          # SPA ã®ãƒªãƒ­ãƒ¼ãƒ‰å¯¾ç­–
          if [ ! -f ".site_out/404.html" ] && [ -f ".site_out/index.html" ]; then
            cp ".site_out/index.html" ".site_out/404.html"
          fi

      - name: Deploy master to gh-pages root (keep pr-* folders)
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: .site_out
          clean: true
          clean-exclude: |
            pr-*

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # deploy: PR push æ™‚ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ / /preview deploy ã‚³ãƒãƒ³ãƒ‰
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    if: |
      (github.event_name == 'pull_request' && github.event.action != 'closed') ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request != null &&
       contains(github.event.comment.body, '/preview deploy'))
    runs-on: ubuntu-latest
    concurrency:
      group: pr-preview-deploy-${{ github.event.issue.number || github.event.pull_request.number }}
      cancel-in-progress: true

    steps:
      # ã‚³ãƒ¡ãƒ³ãƒˆã‚³ãƒãƒ³ãƒ‰æ™‚ã®ã¿æ¨©é™ãƒã‚§ãƒƒã‚¯
      - name: Authorize (issue_comment only)
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const login = context.payload.comment.user.login;
            const prNumber = context.payload.issue.number;
            const { data } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: login,
            });
            const allowed = ["write", "maintain", "admin"].includes(data.permission);
            if (!allowed) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `â›” æ¨©é™ä¸è¶³ã®ãŸã‚å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚\n\nå®Ÿè¡Œè€…: @${login}\næ¨©é™: ${data.permission}\nå¿…è¦: write / maintain / admin`,
              });
              core.setFailed("Insufficient permissions");
            }

      # PRç•ªå·ã®å–å¾—ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥ã«å¿œã˜ã¦ï¼‰
      - name: Get PR number
        id: pr_num
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi

      # issue_comment æ™‚ã®ã¿ PR ã® head ref ã‚’ API å–å¾—
      - name: Get PR head ref (issue_comment only)
        if: github.event_name == 'issue_comment'
        id: pr_api
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.issue.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            core.setOutput("head_ref", pr.head.ref);
            core.setOutput("head_repo", pr.head.repo.full_name);

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || steps.pr_api.outputs.head_ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name || steps.pr_api.outputs.head_repo }}

      - name: Prepare site files
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .preview_out
          rsync -av --delete \
            --exclude ".git/" \
            --exclude ".github/" \
            --exclude "node_modules/" \
            --exclude ".env" \
            --exclude ".env.*" \
            --exclude "*.pem" \
            --exclude "*.key" \
            --exclude "secrets.*" \
            "${SITE_DIR}/" ".preview_out/"

          # SPA ã®ãƒªãƒ­ãƒ¼ãƒ‰å¯¾ç­–
          if [ ! -f ".preview_out/404.html" ] && [ -f ".preview_out/index.html" ]; then
            cp ".preview_out/index.html" ".preview_out/404.html"
          fi

      - name: Deploy to gh-pages (pr-<number>/)
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: .preview_out
          target-folder: pr-${{ steps.pr_num.outputs.number }}
          clean: true

      # PR é…ä¸‹ã«ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ï¼ˆpr-index.htmlï¼‰ã‚’ç”Ÿæˆã—ã¦ã‚³ãƒŸãƒƒãƒˆ
      - name: Generate pr-index.html inside pr-<number>/
        shell: bash
        run: |
          set -euo pipefail
          PR_NUM="${{ steps.pr_num.outputs.number }}"
          PR_DIR="pr-${PR_NUM}"

          rm -rf /tmp/gh-pages
          git clone --depth 1 --branch gh-pages \
            "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" \
            /tmp/gh-pages

          cd /tmp/gh-pages

          if [ ! -d "$PR_DIR" ]; then
            echo "::error::${PR_DIR} not found on gh-pages"
            exit 1
          fi

          python3 - <<'PY'
          import os, html

          pr_dir = os.environ["PR_DIR"]
          ignore_dirs = {".git", ".github", "node_modules"}

          files = []
          for root, dirs, fs in os.walk(pr_dir):
            dirs[:] = [d for d in dirs if d not in ignore_dirs and not d.startswith(".git")]
            for f in fs:
              if f.startswith(".git"):
                continue
              p = os.path.join(root, f)
              rel = os.path.relpath(p, pr_dir)
              if rel == "pr-index.html":
                continue
              files.append(rel)

          files.sort()

          lis = "\n".join(
            f'<li><a href="{html.escape(rel)}">{html.escape(rel)}</a></li>'
            for rel in files
          ) or "<li><em>No files</em></li>"

          out = f"""<!doctype html>
          <html lang="ja">
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1">
          <title>PR files</title>
          <body style="font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 24px;">
            <h1>PR files</h1>
            <p><a href="./">Preview top</a></p>
            <ul>{lis}</ul>
          </body></html>
          """

          with open(os.path.join(pr_dir, "pr-index.html"), "w", encoding="utf-8") as f:
            f.write(out)
          print("Generated:", os.path.join(pr_dir, "pr-index.html"), "files:", len(files))
          PY
        env:
          PR_DIR: pr-${{ steps.pr_num.outputs.number }}

      - name: Commit & push pr-index.html
        shell: bash
        run: |
          set -euo pipefail
          cd /tmp/gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pr-${{ steps.pr_num.outputs.number }}/pr-index.html
          if git diff --cached --quiet; then
            echo "No changes"
            exit 0
          fi
          git commit -m "chore: add/update pr-index for PR #${{ steps.pr_num.outputs.number }}"
          git push

      - name: Upsert comment (preview URL + file list)
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = Number("${{ steps.pr_num.outputs.number }}");
            const isAuto = "${{ github.event_name }}" === "pull_request";
            const trigger = isAuto ? "è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤" : "`/preview deploy`";

            const base = `https://${context.repo.owner}.github.io/${context.repo.repo}`;
            const previewUrl = `${base}/pr-${prNumber}/`;
            const fileListUrl = `${base}/pr-${prNumber}/pr-index.html`;

            const marker = "âœ… Preview deployedï¼ˆ";
            const body =
              `âœ… Preview deployedï¼ˆ${trigger}ï¼‰\n\n` +
              `ğŸ”— ${previewUrl}\n` +
              `ğŸ“„ files: ${fileListUrl}`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100,
            });

            const existing = comments.find(c =>
              c.user?.type === "Bot" &&
              typeof c.body === "string" &&
              c.body.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body,
              });
            }

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # cleanup: PR ã‚¯ãƒ­ãƒ¼ã‚ºæ™‚ã®è‡ªå‹•å‰Šé™¤ / /preview cleanup ã‚³ãƒãƒ³ãƒ‰
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  cleanup:
    if: |
      (github.event_name == 'pull_request' && github.event.action == 'closed') ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request != null &&
       contains(github.event.comment.body, '/preview cleanup'))
    runs-on: ubuntu-latest
    concurrency:
      group: pr-preview-cleanup-${{ github.event.issue.number || github.event.pull_request.number }}
      cancel-in-progress: true

    steps:
      # ã‚³ãƒ¡ãƒ³ãƒˆã‚³ãƒãƒ³ãƒ‰æ™‚ã®ã¿æ¨©é™ãƒã‚§ãƒƒã‚¯
      - name: Authorize (issue_comment only)
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const login = context.payload.comment.user.login;
            const prNumber = context.payload.issue.number;
            const { data } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: login,
            });
            const allowed = ["write", "maintain", "admin"].includes(data.permission);
            if (!allowed) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `â›” æ¨©é™ä¸è¶³ã®ãŸã‚å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚\n\nå®Ÿè¡Œè€…: @${login}\næ¨©é™: ${data.permission}\nå¿…è¦: write / maintain / admin`,
              });
              core.setFailed("Insufficient permissions");
            }

      - name: Get PR number
        id: pr_num
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Cleanup preview folder on gh-pages
        shell: bash
        run: |
          set -euo pipefail
          git clone --depth=1 --branch gh-pages \
            "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" ghp

          cd ghp
          PR_DIR="pr-${{ steps.pr_num.outputs.number }}"

          if [ ! -d "$PR_DIR" ]; then
            echo "No preview found for $PR_DIR. Skipping."
            exit 0
          fi

          rm -rf "$PR_DIR"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A

          if git diff --cached --quiet; then
            echo "Nothing to cleanup"
            exit 0
          fi

          git commit -m "chore: remove preview for PR #${{ steps.pr_num.outputs.number }}"
          git push

      - name: Upsert cleanup comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = Number("${{ steps.pr_num.outputs.number }}");
            const isAuto = "${{ github.event_name }}" === "pull_request";
            const trigger = isAuto ? "PR ã‚¯ãƒ­ãƒ¼ã‚ºï¼ˆè‡ªå‹•ï¼‰" : "`/preview cleanup`";
            const marker = "ğŸ§¹ Preview cleanedï¼ˆ";

            const body = `ğŸ§¹ Preview cleanedï¼ˆ${trigger}ï¼‰\n\npr-${prNumber} ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100,
            });

            const existing = comments.find(c =>
              c.user?.type === "Bot" &&
              typeof c.body === "string" &&
              c.body.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body,
              });
            }
